const isMob=window.innerWidth<900;let dropdown=null,loaderWrapper=null,targetUnit=null,selectedUnit=null,localStorageSelectedUnit=null,electionResults=null;const trustDomains=["https://dw.vecernji.hr","https://www.vecernji.hr","https://synth.24sata.rocks","https://www.24sata.hr","http://127.0.0.1:8000"];function getRandomColor(){let e="#";for(let t=0;t<6;t++)e+="0123456789ABCDEF"[Math.floor(16*Math.random())];return e}function setLiveOrNot(e){const t=document.querySelector(".live");t&&!e&&(t.style.visibility="hidden")}function fixTooltipPosition(){const e=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);e&&document.documentElement.style.setProperty("--textShadow","0 0 1.3px #090909");const t=document.querySelectorAll(".tooltip_wrapper .tooltip");t?.forEach((t=>{if(e&&t.classList.add("after_safari"),!isMob){const n=t.getBoundingClientRect();if(n&&n.x+n.width>window.innerWidth){const n=t.parentNode;n&&(n.style.left="unset",n.style.right="90%",n.style.setProperty("--tooltipPadding","10px 20px 10px 5px")),t.classList.add("hide_after","display_before"),e&&t.classList.add("hide_after","display_before_safari")}}}))}function percentToPixel(e){return e/100*104+39}function placeDataInHtml(e,t=!0){document.getElementById("election_results").replaceChildren();let n="Lista stranaka unutar koalicije:";const o=t?e.ukupnoMandatiGrupirano:e;let s=151;const a=[];o?.forEach((e=>{a.push(e.brMandata)})),s=Math.max(...a);const l=new DocumentFragment;o?.forEach((e=>{e.naziv.toLowerCase().includes("ostal")&&(n="Ostale stranke s mandatima");const o=document.createElement("div");o.setAttribute("class","party_result_wrapper");const a=document.createElement("p");a.textContent=e.naziv,a.setAttribute("class","party"),o.appendChild(a);const r=document.createElement("p");r.textContent=e.brMandata;const i=document.createElement("div"),d=e.brMandata/s*100,c=percentToPixel(d);setTimeout((()=>{isMob?i.style.width=`${d}%`:(i.style.height=`${d}%`,r.style.bottom=`${c}px`)}),150);const p=e.color?e.color:getRandomColor();i.style.backgroundColor=p,e.hover?(i.style.setProperty("--graphHover",e.hover),i.style.filter="unset"):i.style.setProperty("--graphHover",p),i.setAttribute("class","graph");const u=document.createElement("div");u.setAttribute("class","graph_wrapper"),u.appendChild(i),isMob&&u.appendChild(r),o.appendChild(u),isMob||o.appendChild(r);const h=document.createElement("div");h.setAttribute("class","tooltip_wrapper scrollable_wrapper");const m=document.createElement("div");m.setAttribute("class","tooltip");const f=document.createElement("p");f.textContent=n,m.appendChild(f),h.appendChild(m);const g=document.createElement("ul");let w=e.political_parties;t||(w=e.stranke),w?.forEach((e=>{const t=document.createElement("li");t.innerHTML=e.naziv||e,g.appendChild(t)})),m.appendChild(g),o.appendChild(h),l.appendChild(o)}));document.getElementById("election_results").appendChild(l),fixTooltipPosition(),loaderWrapper&&(loaderWrapper.style.display="none")}function setUnitData(e){electionResults.izborne_jedinice?.forEach((t=>{t.ijSifra.includes(e)&&placeDataInHtml(t.lista,!1)}))}function setProcessedVotesAndLastChange(e,t=!0){const n=document.getElementById("processed_votes_and_last_change");if(!n)return;t&&n.replaceChildren();const o=document.getElementById("processed_votes_and_last_change_template").content.cloneNode(!0),s=o.getElementById("processed_votes");s.textContent=`${e?.bmPosto}%`+s.textContent;const a=o.getElementById("last_change"),l=(e?.vrijeme)?.split(":"),r=l?.map((e=>e.padStart(2,"0")));a.textContent+=`${r?.join(":")} H`,n.appendChild(o)}function processData(e,t=!1){t||setProcessedVotesAndLastChange(e.status,!1),placeDataInHtml(e)}function decideHowToProcess(e){"0"===e?processData(electionResults,!0):setUnitData(e)}function setSelectedUnitInMenu(e){targetUnit&&(targetUnit.textContent=e,trustDomains.forEach((t=>{window.parent.postMessage(e,t)})))}function autoRefresh(){loaderWrapper&&(loaderWrapper.style.display="block"),getElectionsData(!0)}function handleRefresh(){setProcessedVotesAndLastChange(electionResults.status),setLiveOrNot(electionResults.live);document.querySelectorAll(".menu_items li").forEach((e=>{e.textContent===targetUnit.textContent&&decideHowToProcess(e.dataset.unit)}))}async function getElectionsData(e=!1){url="https://showcase.24sata.hr/izbori2024/parliamentary-elections-2024-latest.json",fetch(url).then((e=>{if(e.ok)return e.json()})).then((t=>{if(electionResults=t,e)handleRefresh();else if(dropdown=document.querySelector(".dropdown"),loaderWrapper=document.querySelector(".loader_wrapper"),targetUnit=document.querySelector("#target_unit"),selectedUnit=localStorageSelectedUnit||targetUnit.textContent,setLiveOrNot(electionResults.live),processData(electionResults),electionResults.live){const e=electionResults.interval||6e4;setInterval(autoRefresh,e)}}))["catch"]((e=>{console.error(`[Elections widget] Election results data were not retrieved due to: \n${e}`)}))}function debounce(e,t){let n=null;return function(){const o=this,s=arguments;clearTimeout(n),n=setTimeout((()=>{e.apply(o,s)}),t)}}window.addEventListener("pointerup",(e=>{const t=document.querySelector("svg");if(dropdown&&e.composedPath().includes(dropdown))if(dropdown.classList.contains("closed"))dropdown.classList.remove("closed"),t?.classList.add("open");else{dropdown.classList.add("closed"),t?.classList.remove("open");const n=e.target,o=n?n.dataset.unit:null;if(!o)return;loaderWrapper&&(loaderWrapper.style.display="block"),n&&(setSelectedUnitInMenu(n.textContent),n.parentNode.querySelectorAll("li").forEach((e=>{e.classList.remove("selected")})),n.classList.add("selected")),decideHowToProcess(o)}else dropdown.classList.add("closed"),t?.classList.remove("open")})),document.addEventListener("DOMContentLoaded",(()=>{getElectionsData()})),window.addEventListener("message",(e=>{if(trustDomains.indexOf(e.origin)>=0){const t=e.data;selectedUnit=t,targetUnit&&(targetUnit.textContent=t),localStorageSelectedUnit=t,loaderWrapper&&(loaderWrapper.style.display="block"),setSelectedUnitInMenu(t),electionResults?handleRefresh():getElectionsData(!0)}})),window.addEventListener("resize",debounce((()=>{window.innerWidth<900!==isMob&&window.location.reload()}),200));
